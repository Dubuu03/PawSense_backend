<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLO Detection Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-section {
            border: 2px dashed #ddd;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            border-radius: 8px;
            background: #fafafa;
        }
        .upload-section:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }
        input[type="file"] {
            margin: 10px;
            padding: 8px;
        }
        .model-selector {
            margin: 20px 0;
            text-align: center;
        }
        .model-selector label {
            margin: 0 15px;
            cursor: pointer;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        .detection-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .image-container {
            position: relative;
            display: inline-block;
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        .detection-image {
            max-width: 100%;
            max-height: 500px;
            display: block;
        }
        .bounding-box {
            position: absolute;
            border: 3px solid #ff4444;
            background: rgba(255, 68, 68, 0.1);
            pointer-events: none;
        }
        .detection-label {
            position: absolute;
            background: #ff4444;
            color: white;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 3px;
            white-space: nowrap;
        }
        .image-info {
            text-align: center;
            margin: 10px 0;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üê±üê∂ YOLO Detection Tester</h1>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
            <h4 style="margin: 0 0 10px 0; color: #1976d2;">üåê API Configuration</h4>
            <p style="margin: 0; font-family: monospace; font-size: 14px; color: #424242;">
                <strong>Current API URL:</strong> 
                <span id="currentApiUrl" style="color: #d32f2f;">{API_BASE_URL}</span>
            </p>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                ‚ö†Ô∏è Update the API_BASE_URL in the script section with your Railway deployment URL
            </p>
        </div>
        
        <div class="upload-section">
            <h3>Upload Your Image</h3>
            <p>Select an image file to test skin condition detection</p>
            <input type="file" id="imageFile" accept="image/*" />
        </div>
        
        <div class="model-selector">
            <h4>Choose Model:</h4>
            <label>
                <input type="radio" name="model" value="cats" checked /> 
                üê± Cats Model
            </label>
            <label>
                <input type="radio" name="model" value="dogs" /> 
                üê∂ Dogs Model
            </label>
        </div>
        
        <div style="text-align: center;">
            <button onclick="checkHealth()" id="healthBtn">
                üíö Check Server Health
            </button>
            <button onclick="uploadImage()" id="uploadBtn">
                üîç Detect Conditions
            </button>
            <button onclick="clearResults()">
                üóëÔ∏è Clear Results
            </button>
        </div>
        
        <div id="results" class="results"></div>
    </div>

    <script>
        // API Configuration - Update this with your Railway deployment URL
        const API_BASE_URL = 'https://pawsensebackend-production.up.railway.app'; // Replace with your actual Railway URL
        // For local testing, use: const API_BASE_URL = 'http://localhost:8000';
        
        function getApiBaseUrl() {
            return API_BASE_URL;
        }
        
        function getSelectedModel() {
            const radios = document.getElementsByName('model');
            for (let radio of radios) {
                if (radio.checked) {
                    return radio.value;
                }
            }
            return 'cats';
        }

        async function uploadImage() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            const resultsDiv = document.getElementById('results');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (!file) {
                showError('Please select an image file first!');
                return;
            }
            
            // Basic file validation
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp', 'image/tiff'];
            
            if (file.size > maxSize) {
                showError(`File too large! Maximum size is 10MB. Your file is ${(file.size / (1024 * 1024)).toFixed(2)}MB`);
                return;
            }
            
            if (!allowedTypes.includes(file.type.toLowerCase())) {
                showError(`Invalid file type! Allowed types: JPEG, PNG, BMP, TIFF. Your file type: ${file.type}`);
                return;
            }
            
            const model = getSelectedModel();
            console.log('File details:', {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: file.lastModified
            });
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Show loading
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'üîÑ Detecting...';
            resultsDiv.innerHTML = '<div class="loading">üîÑ Processing your image...</div>';
            resultsDiv.style.display = 'block';
            
            try {
                console.log('Uploading to:', `${getApiBaseUrl()}/detect/${model}`);
                console.log('FormData contents:', [...formData.entries()]);
                
                const response = await fetch(`${getApiBaseUrl()}/detect/${model}`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                
                console.log('Upload response status:', response.status);
                console.log('Upload response headers:', [...response.headers.entries()]);
                
                const result = await response.json();
                
                if (response.ok) {
                    showResults(result);
                } else {
                    console.error('Backend error:', result);
                    showError(`Error (${response.status}): ${result.error || result.detail || 'Unknown error occurred'}`);
                }
            } catch (error) {
                showError(`Connection error: ${error.message}. Make sure the server is running on ${getApiBaseUrl()}`);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üîç Detect Conditions';
            }
        }
        
        function showResults(result) {
            const resultsDiv = document.getElementById('results');
            
            let html = `
                <div class="success">
                    ‚úÖ Detection completed successfully!
                </div>
                <h4>üìä Results for: ${result.filename}</h4>
                <p><strong>Total detections:</strong> ${result.total_detections}</p>
            `;

            // Add image with bounding boxes
            html += '<div id="imageVisualization"></div>';
            
            if (result.detections && result.detections.length > 0) {
                html += '<h4>üîç Detections Found:</h4>';
                
                result.detections.forEach((detection, index) => {
                    const confidence = (detection.confidence * 100).toFixed(1);
                    const color = getDetectionColor(index);
                    html += `
                        <div class="detection-item" style="border-left-color: ${color};">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 20px; height: 20px; background: ${color}; margin-right: 10px; border-radius: 3px;"></div>
                                <div>
                                    <strong>${index + 1}. ${detection.label}</strong>
                                    <br>Confidence: ${confidence}%
                                    <br>Bounding Box: [${detection.bbox.map(b => b.toFixed(1)).join(', ')}]
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p>‚ÑπÔ∏è No skin conditions detected in this image.</p>';
            }
            
            // Add model info
            html += `
                <details style="margin-top: 20px;">
                    <summary><strong>üìã Model Information</strong></summary>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px;">
${JSON.stringify(result.model_info, null, 2)}
                    </pre>
                </details>
            `;
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            
            // Draw image with bounding boxes
            drawImageWithBoundingBoxes(result);
        }

        function getDetectionColor(index) {
            const colors = [
                '#ff4444', '#44ff44', '#4444ff', '#ffaa44', 
                '#ff44aa', '#44aaff', '#aaff44', '#aa44ff',
                '#ffaa88', '#88ffaa', '#aa88ff', '#ff8844'
            ];
            return colors[index % colors.length];
        }

        function drawImageWithBoundingBoxes(result) {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Create container
                    const container = document.createElement('div');
                    container.className = 'image-container';
                    container.style.position = 'relative';
                    
                    // Create image element
                    const imageElement = document.createElement('img');
                    imageElement.src = e.target.result;
                    imageElement.className = 'detection-image';
                    imageElement.style.display = 'block';
                    
                    container.appendChild(imageElement);
                    
                    // Wait for image to render, then draw bounding boxes
                    imageElement.onload = function() {
                        const imgRect = imageElement.getBoundingClientRect();
                        const containerRect = container.getBoundingClientRect();
                        
                        // Calculate scale factors
                        const scaleX = imageElement.offsetWidth / img.naturalWidth;
                        const scaleY = imageElement.offsetHeight / img.naturalHeight;
                        
                        // Draw bounding boxes
                        result.detections.forEach((detection, index) => {
                            const [x1, y1, x2, y2] = detection.bbox;
                            const color = getDetectionColor(index);
                            
                            // Create bounding box
                            const bbox = document.createElement('div');
                            bbox.className = 'bounding-box';
                            bbox.style.left = (x1 * scaleX) + 'px';
                            bbox.style.top = (y1 * scaleY) + 'px';
                            bbox.style.width = ((x2 - x1) * scaleX) + 'px';
                            bbox.style.height = ((y2 - y1) * scaleY) + 'px';
                            bbox.style.borderColor = color;
                            bbox.style.backgroundColor = color + '20'; // Add transparency
                            
                            // Create label
                            const label = document.createElement('div');
                            label.className = 'detection-label';
                            label.style.backgroundColor = color;
                            label.style.left = (x1 * scaleX) + 'px';
                            label.style.top = (y1 * scaleY - 25) + 'px';
                            label.textContent = `${detection.label} (${(detection.confidence * 100).toFixed(1)}%)`;
                            
                            container.appendChild(bbox);
                            container.appendChild(label);
                        });
                    };
                    
                    // Add image info
                    const imageInfo = document.createElement('div');
                    imageInfo.className = 'image-info';
                    imageInfo.innerHTML = `
                        üìè Image Size: ${img.naturalWidth} √ó ${img.naturalHeight} pixels<br>
                        üìä Detections: ${result.total_detections} found
                    `;
                    
                    // Insert into visualization area
                    const vizArea = document.getElementById('imageVisualization');
                    vizArea.innerHTML = '';
                    vizArea.appendChild(container);
                    vizArea.appendChild(imageInfo);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function showError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="error">‚ùå ${message}</div>`;
            resultsDiv.style.display = 'block';
        }
        
        function clearResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'none';
            document.getElementById('imageFile').value = '';
        }
        
        // Allow drag and drop
        const uploadSection = document.querySelector('.upload-section');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#007bff';
            uploadSection.style.background = '#f0f8ff';
        });
        
        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#ddd';
            uploadSection.style.background = '#fafafa';
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#ddd';
            uploadSection.style.background = '#fafafa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('imageFile').files = files;
            }
        });

        // Initialize the interface
        function init() {
            console.log('üöÄ YOLO Detection Tester initialized');
            
            // Update the displayed API URL
            const urlDisplay = document.getElementById('currentApiUrl');
            if (urlDisplay) {
                urlDisplay.textContent = getApiBaseUrl();
                
                // Color code the URL based on whether it's localhost or production
                if (getApiBaseUrl().includes('localhost')) {
                    urlDisplay.style.color = '#f57c00'; // Orange for localhost
                } else {
                    urlDisplay.style.color = '#388e3c'; // Green for production
                }
            }
        }

        // Check server health
        async function checkHealth() {
            const healthBtn = document.getElementById('healthBtn');
            const resultsDiv = document.getElementById('results');
            
            healthBtn.disabled = true;
            healthBtn.textContent = 'üîÑ Checking...';
            
            try {
                console.log('Testing API connection to:', getApiBaseUrl());
                
                // Test basic health endpoint with proper headers
                const healthResponse = await fetch(`${getApiBaseUrl()}/health`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors'
                });
                
                console.log('Health response status:', healthResponse.status);
                console.log('Health response headers:', [...healthResponse.headers.entries()]);
                
                const healthData = await healthResponse.json();
                
                let healthStatus = '';
                if (healthResponse.ok) {
                    healthStatus = `‚úÖ Server Health: ${healthData.status}\n`;
                    healthStatus += `üìä Models Loaded: ${healthData.models_loaded.join(', ')}\n`;
                    healthStatus += `üìã Available Models: ${healthData.available_models.join(', ')}\n`;
                    healthStatus += `üåê API URL: ${getApiBaseUrl()}\n`;
                    healthStatus += `üîó Connection: CORS Enabled, Working`;
                } else {
                    healthStatus = `‚ùå Server Health Check Failed: ${healthData.error || 'Unknown error'}`;
                }
                
                resultsDiv.innerHTML = `<div style="background: #f0f8ff; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap;">${healthStatus}</div>`;
                resultsDiv.style.display = 'block';
                
            } catch (error) {
                console.error('Health check error:', error);
                let errorMsg = `‚ùå Connection failed: ${error.message}\n\n`;
                errorMsg += `üåê Trying to connect to: ${getApiBaseUrl()}\n`;
                errorMsg += `üè† From origin: ${window.location.origin}\n\n`;
                errorMsg += `üí° Possible fixes:\n`;
                errorMsg += `1. Check if Railway deployment is running\n`;
                errorMsg += `2. Verify CORS configuration on backend\n`;
                errorMsg += `3. Try opening ${getApiBaseUrl()}/health directly in browser\n`;
                errorMsg += `4. Check browser console for detailed error`;
                
                resultsDiv.innerHTML = `<div class="error">${errorMsg}</div>`;
                resultsDiv.style.display = 'block';
            } finally {
                healthBtn.disabled = false;
                healthBtn.textContent = 'üíö Check Server Health';
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>